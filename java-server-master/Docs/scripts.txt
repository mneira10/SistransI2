
--RFC12


(SELECT *
FROM USUARIOS_REGISTRADOS
  NATURAL JOIN
  (SELECT ID_USUARIO_REGISTRADO AS ID
      FROM HISTORIAL
      GROUP BY ID_USUARIO_REGISTRADO
      HAVING (COUNT(DISTINCT TO_NUMBER(TO_CHAR(HISTORIAL.FECHA, 'WW')))-1
          = TO_NUMBER(TO_CHAR(SYSDATE, 'WW')) - MIN(TO_NUMBER(TO_CHAR(HISTORIAL.FECHA, 'WW')) )) ))

UNION

(SELECT *
FROM USUARIOS_REGISTRADOS  WHERE TIPO LIKE NULL
MINUS
(SELECT U.*
FROM USUARIOS_REGISTRADOS U JOIN (HISTORIAL NATURAL JOIN (SELECT ID AS ID_PRODUCTO
FROM MENUS )) ON (U.ID=ID_USUARIO_REGISTRADO)))


UNION

(SELECT *
FROM USUARIOS_REGISTRADOS WHERE TIPO LIKE NULL

MINUS

(SELECT U.*
FROM USUARIOS_REGISTRADOS U JOIN (HISTORIAL NATURAL JOIN (SELECT ID AS ID_PRODUCTO
FROM PRODUCTOS
WHERE PRECIO <= 36885.84)) ON (U.ID=ID_USUARIO_REGISTRADO)));


--RFC9 usuarios que consumieron al menos un producto de un determinado restaurante en un rango de fechas.


SELECT *
FROM USUARIOS JOIN (SELECT * 
FROM PRODUCTOS JOIN HISTORIAL ON (HISTORIAL.ID_PRODUCTO = PRODUCTOS.ID)
WHERE PRODUCTOS.ID_RESTAURANTE = idRestaurante AND (to_date(to_char(HISTORIAL.FECHA, 'YYYY/MM/DD HH24:MI:SS'), 'YYYY/MM/DD HH24:MI:SS') between to_date(fecha1, 'YYYY/MM/DD HH24:MI:SS') and to_date(fecha2, 'YYYY/MM/DD HH24:MI:SS')))
ON (USUARIOS.ID=PRODUCTOS.ID_USUARIO);


--RFC10 usuarios que consumieron al menos un producto de un determinado restaurante en un rango de fechas.


SELECT * FROM USUARIOS 
MINUS
SELECT *
FROM USUARIOS JOIN (SELECT * 
FROM PRODUCTOS JOIN HISTORIAL ON (HISTORIAL.ID_PRODUCTO = PRODUCTOS.ID)
WHERE PRODUCTOS.ID_RESTAURANTE = idRestaurante AND (to_date(to_char(HISTORIAL.FECHA, 'YYYY/MM/DD HH24:MI:SS'), 'YYYY/MM/DD HH24:MI:SS') between to_date(fecha1, 'YYYY/MM/DD HH24:MI:SS') and to_date(fecha2, 'YYYY/MM/DD HH24:MI:SS')))
ON (USUARIOS.ID=PRODUCTOS.ID_USUARIO);


--RFC11 Muestra,  para  cada  día  de  la semana, el  producto más consumido, el  producto  menos  consumido,
-- el  restaurante más frecuentado y el  restaurante  menos  frecuentado.


-- mas consumido

WITH TEMP AS (
      SELECT DIA1, MAX(CONT) CONTEO FROM (SELECT  ID_PRODUCTO, DIA AS DIA1, CONT
        FROM (SELECT H.ID_PRODUCTO ID_PRODUCTO, to_char(H.FECHA, 'd') DIA , COUNT(H.ID_PRODUCTO) CONT
                FROM HISTORIAL H
                GROUP BY to_char(H.FECHA, 'd'), H.ID_PRODUCTO))
        GROUP BY DIA1) ,

    TEMP2 AS (

      SELECT *
        FROM TEMP
        JOIN (SELECT  ID_PRODUCTO, DIA AS DIA2, CONT
        FROM (SELECT H.ID_PRODUCTO ID_PRODUCTO, to_char(H.FECHA, 'd') DIA , COUNT(H.ID_PRODUCTO) CONT
                FROM HISTORIAL H
                GROUP BY to_char(H.FECHA, 'd'), H.ID_PRODUCTO))
        ON TEMP.DIA1 = DIA2 AND TEMP.CONTEO = CONT)

SELECT DISTINCT DIA2 AS DIA_SEMANA,CONT AS CANTIDAD , first_value(ID_PRODUCTO)
  OVER (PARTITION BY DIA2,CONT ) AS PRODUCTO_ID
  FROM  TEMP2
  ORDER BY DIA2 ASC;

-- menos consumido

WITH TEMP AS (
      SELECT DIA1, MIN(CONT) CONTEO FROM (SELECT  ID_PRODUCTO, DIA AS DIA1, CONT
        FROM (SELECT H.ID_PRODUCTO ID_PRODUCTO, to_char(H.FECHA, 'd') DIA , COUNT(H.ID_PRODUCTO) CONT
                FROM HISTORIAL H
                GROUP BY to_char(H.FECHA, 'd'), H.ID_PRODUCTO))
        GROUP BY DIA1) ,

    TEMP2 AS (

      SELECT *
        FROM TEMP
        JOIN (SELECT  ID_PRODUCTO, DIA AS DIA2, CONT
        FROM (SELECT H.ID_PRODUCTO ID_PRODUCTO, to_char(H.FECHA, 'd') DIA , COUNT(H.ID_PRODUCTO) CONT
                FROM HISTORIAL H
                GROUP BY to_char(H.FECHA, 'd'), H.ID_PRODUCTO))
        ON TEMP.DIA1 = DIA2 AND TEMP.CONTEO = CONT)

SELECT DISTINCT DIA2 AS DIA_SEMANA , CONT AS CANTIDAD , first_value(ID_PRODUCTO)
  OVER (PARTITION BY DIA2,CONT ) AS PRODUCTO_ID
  FROM  TEMP2
  ORDER BY DIA2 ASC;
  
  --restaurante mas frecuentado
  
  --restaurante menos frecuentado
